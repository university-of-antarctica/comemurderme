<!DOCTYPE html>
<!--
  Copyright (c) 2012-2014 Adobe Systems Incorporated. All rights reserved.

  Licensed to the Apache Software Foundation (ASF) under one
  or more contributor license agreements.  See the NOTICE file
  distributed with this work for additional information
  regarding copyright ownership.  The ASF licenses this file
  to you under the Apache License, Version 2.0 (the
  "License"); you may not use this file except in compliance
  with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing,
  software distributed under the License is distributed on an
  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  KIND, either express or implied.  See the License for the
  specific language governing permissions and limitations
  under the License.
-->
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <title>ComeMurder.Me</title>
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.2/jquery.mobile-1.1.2.min.css" />
    <script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.1.2/jquery.mobile-1.1.2.min.js"></script>
    <script type="text/javascript" charset="utf-8">
      //TODO add timeout if function doesn't return in a reasonable amonut of time.
      //TODO look at efficacy of pageshow function

      // example from http://docs.phonegap.com/en/edge/cordova_geolocation_geolocation.md.html
        // Wait for device API libraries to load
        //
        document.addEventListener("deviceready", onDeviceReady, false);
        var myFilesystem;

        // device APIs are available
        //
        function onDeviceReady() {
          navigator.geolocation.getCurrentPosition(onSuccess, onError);
          window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFS, fail);
          //POST variables for options.params in upload()
          window.userDateTime;
          window.userFbId;
          window.userLocation;
          window.userComment;
          var dateObj = new Date();
          window.userDateTime = dateObj.toLocaleString();


        }


        // image/filesystem manipulation

        function gotFS(fileSystem) {
          myFilesystem = fileSystem;
        }
        
        function requestFile(filename){
          fileSystem.root.getFile(filename, null, gotFileEntry, fail);
        }

        function gotFileEntry(fileEntry) {
          fileEntry.file(gotFile, fail);
        }

        function gotFile(file){
          console.log("gotFile");
          upload(file);
          readDataUrl(file);
        }

        function readDataUrl(file) {
          console.log("reading data...");
          var reader = new FileReader();
          console.log("reader instantiated?");
          reader.onloadend = function(evt) {
            console.log("Read as data URL");
            console.log(evt.target.result);
          };
          console.log("file to read: " + file);
          reader.readAsDataURL(file);
        }

        function fail(evt) {
          console.log(evt.target.error.code);
        }

        // onSuccess Geolocation
        //
        function onSuccess(position) {
          window.userLocation = {
            "lat"   : position.coords.latitude,
            "lng"   : position.coords.longitude
          };
          var element = document.getElementById('geolocation');
          element.innerHTML = 'Latitude: '           + position.coords.latitude              + '<br />' +
            'Longitude: '          + position.coords.longitude             + '<br />' +
            'Altitude: '           + position.coords.altitude              + '<br />' +
            'Accuracy: '           + position.coords.accuracy              + '<br />' +
            'Altitude Accuracy: '  + position.coords.altitudeAccuracy      + '<br />' +
            'Heading: '            + position.coords.heading               + '<br />' +
            'Speed: '              + position.coords.speed                 + '<br />' +
            'Timestamp: '          + position.timestamp                    + '<br />';
        }

        // onError Callback receives a PositionError object
        //
        function onError(error) {
          alert('code: '    + error.code    + '\n' +
              'message: ' + error.message + '\n');
        }

            </script>
            <script type="text/javascript" charset="utf-8">

        var pictureSource;   // picture source
        var destinationType; // sets the format of returned value 

        // Wait for PhoneGap to connect with the device
        //
        document.addEventListener("deviceready",onDeviceReady,false);

        // PhoneGap is ready to be used!
        //
        function onDeviceReady() {
          pictureSource=navigator.camera.PictureSourceType;
          destinationType=navigator.camera.DestinationType;
        }

        // Called when a photo is successfully retrieved
        //
        function onPhotoDataSuccess(imageData) {
          // Get image handle
          //
          //TODO find out with function to feed imageData file URI to!!
          console.log("imageData: " + imageData);
          var base64_image = gotFile(imageData);
          console.log("image?: " + base64_image);

          var smallImage = document.getElementById('smallImage');

          // Unhide image elements
          //
          smallImage.style.display = 'block';

          // Show the captured photo
          // The inline CSS rules are used to resize the image
          //
          //TODO THIS LINE IS BROKEN smallImage.src = "data:image/jpeg;base64," + imageData;
          smallImage.src = imageData; //IMAGE is actually just a fileURI
        }

        // Called when a photo is successfully retrieved
        //
        function onPhotoFileSuccess(imageData) {
          // Get image handle
          console.log(JSON.stringify(imageData));

          // Get image handle
          //
          var smallImage = document.getElementById('smallImage');

          // Unhide image elements
          //
          smallImage.style.display = 'block';

          // Show the captured photo
          // The inline CSS rules are used to resize the image
          //
          smallImage.src = imageData;
        }
      
        // Called when a photo is successfully retrieved
        //
        function onPhotoURISuccess(imageURI) {
          // Uncomment to view the image file URI 
          // console.log(imageURI);

          // Get image handle
          //
          var largeImage = document.getElementById('largeImage');

          // Unhide image elements
          //
          largeImage.style.display = 'block';

          // Show the captured photo
          // The inline CSS rules are used to resize the image
          //
          largeImage.src = imageURI;
        }

        // A button will call this function
        //
        function capturePhotoWithData() {
          // Take picture using device camera and retrieve image as base64-encoded string
          console.log("begin call to navigator");
          navigator.camera.getPicture(onPhotoDataSuccess, onFail, { quality: 50 });
          console.log("end call to navigator");
        }

        function capturePhotoWithFile() {
          navigator.camera.getPicture(onPhotoFileSuccess, onFail, { quality: 50, destinationType: Camera.DestinationType.FILE_URI });
        }

        // A button will call this function
        //
        function getPhoto(source) {
          // Retrieve image file location from specified source
          navigator.camera.getPicture(onPhotoURISuccess, onFail, { quality: 50, 
            destinationType: destinationType.FILE_URI,
            sourceType: source });
        }

        // Called if something bad happens.
        // 
        function onFail(message) {
          console.log("failed because: " + message);
          alert('Failed because: ' + message);
        }
        var serverURL = "http://192.168.1.7:8289"

          upload = function (imageURI) {
            console.log("comment: " + window.userComment);
            
            console.log("UPLOAD FTW");
              var ft = new FileTransfer(),
                options = new FileUploadOptions();

            options.fileKey = "file";
            options.fileName = 'filename.jpg'; // We will use the name auto-generated by Node at the server side.
            options.mimeType = "image/jpeg";
            options.chunkedMode = false;
            options.params = { // Whatever you populate options.params with, will be available in req.body at the server-side.
                "userdatetime" : window.userDateTime,
                "userfbid"     : window.userFbId,
                "userlocation" : window.userLocation,
                "usercomment"  : window.userComment
            };

            ft.upload(imageURI, serverURL + "/images",
                function (e) {
                  alert("Murdlet Submitted, Head over to comemurder.me to check it out!");
                },
                function (e) {
                    alert("Upload failed");
                }, options);
      };

            </script>
            <script src="openfb.js"></script>
            <script>

        // Defaults to sessionStorage for storing the Facebook token
        openFB.init({appId: '740619572749259'});

        //  Uncomment the line below to store the Facebook token in localStorage instead of sessionStorage
        //  openFB.init({appId: 'YOUR_FB_APP_ID', tokenStore: window.localStorage});

        function login() {
          openFB.login(
              function(response) {
                if(response.status === 'connected') {
                  alert('Facebook login succeeded, got access token: ' + response.authResponse.accessToken);
                } else {
                  alert('Facebook login failed: ' + response.error);
                }
              }, {scope: 'email'});
        }

        function getInfo() {
          openFB.api({
            path: '/me',
            success: function(data) {
              console.log(JSON.stringify(data));
              document.getElementById("userName").innerHTML = data.name;
              document.getElementById("userPic").src = 'http://graph.facebook.com/' + data.id + '/picture?type=small';
              window.userFbId = data.id;
            },
            error: errorHandler});
        }

        function readPermissions() {
          openFB.api({
            method: 'GET',
            path: '/me/permissions',
            success: function(result) {
              alert(JSON.stringify(result.data));
            },
            error: errorHandler
          });
        }

        function revoke() {
          openFB.revokePermissions(
              function() {
                alert('Permissions revoked');
              },
              errorHandler);
        }

        function logout() {
          openFB.logout(
              function() {
                alert('Logout successful');
              },
              errorHandler);
        }

        function errorHandler(error) {
          alert(error.message);
        }

$(document).on('pagecreate', function() {
      $("#usertextarea").on('change', function() {
          window.userComment = this.value;
      })
});


    </script>

  </head>
  <body>

    <div class="app">

      <div id="deviceready">


        <div id="one" data-role="page" class="page-content">
          <br><br>
          <h1>ComeMurder.me</h1>
          <p class="event listening">Connecting to Device</p>
          <p class="event received">Device is Ready</p>
          <p id="geolocation">Finding geolocation...</p>
          <a href="#two" data-role="button" data-corners="true" data-shadow="true" data-iconshadow="true" data-wrapperels="span" data-theme="c" class="ui-btn ui-shadow ui-btn-corner-all ui-btn-up-c"><span class="ui-btn-inner ui-btn-corner-all"><span class="ui-btn-text">Next</span></span></a>
        </div>

        <div id="two" data-role="page" class="page-content">
          <!-- TODO https://developers.facebook.com/docs/facebook-login/permissions/v2.5 -->
          <br><br>
          <h1>ComeMurder.me</h1>
          <button class="btn btn-block" onclick="login()">Login with Facebook</button>
          <hr/>
          <button class="btn btn-block" onclick="getInfo()">Get My Info</button>
          <p>Name: <span id="userName"></span></p>
          <img id="userPic"/>
          <hr/>
          <!--

          <p>Complete Facebook Logout. After logging out, you'll have to login again and provide your Facebook credentials.</p>
          <button class="btn btn-block" onclick="logout()">Logout</button>
          <hr/>

          <button class="btn btn-block" onclick="readPermissions()">Read Permissions</button>

          <p>Revoke App Permissions. After revoking permissions, you'll have to grant permissions again when logging in.</p>
          <button class="btn btn-block" onclick="revoke()">Revoke Permissions</button>
          -->
          <a href="#three" data-role="button" data-corners="true" data-shadow="true" data-iconshadow="true" data-wrapperels="span" data-theme="c" class="ui-btn ui-shadow ui-btn-corner-all ui-btn-up-c"><span class="ui-btn-inner ui-btn-corner-all"><span class="ui-btn-text">Next</span></span></a>
        </div>

        <div id="three" data-role="page" class="page-content">
          <br><br>
          <h1>ComeMurder.me</h1>
          <p>Add an optional comment </p>
          <textarea id="usertextarea" maxlength="140"></textarea>
          <a href="#four" data-role="button" data-corners="true" data-shadow="true" data-iconshadow="true" data-wrapperels="span" data-theme="c" class="ui-btn ui-shadow ui-btn-corner-all ui-btn-up-c"><span class="ui-btn-inner ui-btn-corner-all"><span class="ui-btn-text">Next</span></span></a>
        </div>

        <div id="four" data-role="page" class="page-content">
          <br><br>
	  <h1>ComeMurder.me</h1>
	  <br>
          <button onclick="capturePhotoWithData();">Capture Photo With Image Data</button> <br>
          <!-- button onclick="capturePhotoWithFile();">Capture Photo With Image File URI</button> <br> 
          //TODO take out the corresponding function here.-->
          <button onclick="getPhoto(pictureSource.PHOTOLIBRARY);">From Photo Library</button><br>
          <button onclick="getPhoto(pictureSource.SAVEDPHOTOALBUM);">From Photo Album</button><br>
          <img style="display:none;width:60px;height:60px;" id="smallImage" src="" />
          <img style="display:none;" id="largeImage" src="" />
          <a href="#one" data-role="button" data-corners="true" data-shadow="true" data-iconshadow="true" data-wrapperels="span" data-theme="c" class="ui-btn ui-shadow ui-btn-corner-all ui-btn-up-c"><span class="ui-btn-inner ui-btn-corner-all"><span class="ui-btn-text">Next</span></span></a>
        </div>
        <!--
          $("#page_id").on("pageshow" , function() {
          showMap();
          });
        -->


      </div>

    </div>

    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    <script type="text/javascript">
app.initialize();
    </script>
  </body>
</html>
